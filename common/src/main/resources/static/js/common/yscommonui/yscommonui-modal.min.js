(function($) {
	
	$.fn.YSModalDialog = function(options) {
		
		var href = $(this).attr('href');
		
		if(typeof options === 'string' && options == "close"){
			$(this).iziModal('close');
			return true;
		}
		
		var dialogId,
			ysModalDialogOpt = {
			radius: 10,
				
			position: 'center',
			width: '60vw',
			height: 'auto',
			resize: 'auto',
			zindex: 1001,
			resizable: false,
			closeOnEscape: false,
			modal: true,
			
		    onOpening: function(modal){
				modal.$wrap.children(".iziModal-content")
          			.remove(".icon-close")
          			.append('<button data-izimodal-close="" class="icon-close fa fa-times"></button>');
				modal.startLoading();
		    },
		    onOpened: function(modal) {
				$('.formError').remove(); // Clear validation error message
				$(this).parent().focus();
/*
				if (options && typeof options.iziModal(Title === 'string') {
					$(this).dialog('option', 'title', removeMtag(options.dialogTitle));
				}
				else {
					$(this).dialog('option', 'title', '');
				}
*/
				// Comment out for the compatibility with jquery 1.12.1
				//$(this).dialog('resize');
				modal.stopLoading();
				
				$(this).dialog = function(msg){
					if(msg == "close"){
						$(this).iziModal('close');
					}else{
						console.log("error parameter");
					}
				}
				
				if (typeof options === 'object' && typeof window[options.afterOpen] === 'function') {
					window[options.afterOpen]();
				}
			},
			onClosed: function(modal) {
				if (typeof options === 'object' && typeof window[options.afterClose] === 'function') {
					window[options.afterClose]();
				}
			}
		},
		ysModalDialogIframeOpt = {
				radius: 10,
				autoOpen: false,
				position: 'center',
				width: '60vw',
				height: 'auto',
				zindex: 1001,
				resizable: false,
				closeOnEscape: false,
				modal: true,
			    onOpening: function(modal){
					modal.$wrap.children(".iziModal-content")
	          			.remove(".icon-close")
	          			.append('<button data-izimodal-close="" class="icon-close fa fa-times"></button>');
					
					modal.startLoading();
					return true;
			    },
			    onOpened: function(modal) {
/*					
					if (options && typeof options.dialogTitle === 'string') {
						$(this).dialog('option', 'title', removeMtag(options.dialogTitle));
					}
					else {
						$(this).dialog('option', 'title', '');
					}
*/
			    	modal.stopLoading();
			    	
					$(this).dialog = function(msg){
						if(msg == "close"){
							$(this).iziModal('close');
						}else{
							console.log("error parameter");
						}
					}
					
					if (typeof options === 'object' && typeof window[options.afterOpen] === 'function') {
						window[options.afterOpen]();
					}
				},
				onClosed: function(modal) {
					if (typeof options === 'object' && typeof window[options.afterClose] === 'function') {
						window[options.afterClose]();
					}
				}
			}, optionObj={};
			
		if (typeof options != 'undefined' && typeof options.dialogId != 'undefined') {
			dialogId = options.dialogId;
		}
		else if(href && href.charAt(0) == '#'){
			dialogId = "-" + $(this).attr('id');
		}
		else{
			dialogId = "";
		}

		if (typeof options === 'object') {
			optionObj = options;
		}

		if (optionObj.iframe) {
			if ($('#YSDialogIframe'+dialogId).length > 0) {
				$('#YSDialogIframe'+dialogId).remove();
			}
			$('body').append('<div id="YSDialogIframe'+dialogId+'" style="overflow:hidden;display:none; padding: 0px;z-index:999999;">' +
						'<iframe id="ysIframe'+dialogId+'" name="ysIframe'+dialogId+'" width="100%" height="100%" marginWidth="0" marginHeight="0" frameBorder="0" scrolling="no"/></div>');
			
		}
		
/*		
		else if (href && href.charAt(0) == '#'){
			if ($('#YSModalDialog'+dialogId).length == 0) {
				$('body').append('<div id="YSModalDialog'+dialogId+'" style="overflow:hidden;display:none; z-index:999999;"/><div id="loading-div"'+dialogId+' style="display: none; position: ' +
						' absolute; top: 0; left: 0; width: 100%; height: 100%;">' +
						' <div style="position: absolute; width: 100%; min-height: 100%; height: auto; opacity: .6; filter:Alpha(Opacity=60); background-color: #616161; z-index: 10000;"></div>' +
						' <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url(' + getImageURL("loading_animate.gif") + ');'+
						' background-attachment: fixed; background-repeat: no-repeat; background-position: center; z-index:10001;"></div></div>');
			}
		}
*/		
		else{
			console.log("clear YSModalDialog");
			
			if (href && href.charAt(0) == '#' && $('[id='+ href.slice(1) +']').length == 1){
				$(href).appendTo($('body'));
			}
			
			if ($('#YSModalDialog'+dialogId).length > 0) {
				$('#YSModalDialog'+dialogId).remove();
			}
			
			console.log("add YSModalDialog");
			$('body').append('<div id="YSModalDialog'+dialogId+'" style="overflow:hidden;display:none; z-index:999999;"/><div id="loading-div"'+dialogId+' style="display: none; position: ' +
					' absolute; top: 0; left: 0; width: 100%; height: 100%;">' +
					//' <div style="position: absolute; width: 100%; min-height: 100%; height: auto; opacity: .6; filter:Alpha(Opacity=60); background-color: #616161; z-index: 10000;"></div>' +
					//' <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url(' + getImageURL("loading_animate.gif") + ');'+
					//' background-attachment: fixed; background-repeat: no-repeat; background-position: center; z-index:10001;"></div>'
					'</div>');
		
		}

		if (optionObj.dialogData) {
			$('#YSModalDialog'+dialogId).empty().html(optionObj.dialogData);
			$('#YSModalDialog'+dialogId).iziModal(ysModalDialogOpt);
			$('#YSModalDialog'+dialogId).iziModal('open');
			setTimeout(function() {
				$('#YSModalDialog'+dialogId).css('min-height', 'inherit');
			}, 10);
			/*
			if (typeof options === 'object' && typeof window[options.afterOpen] === 'function') {
				window[options.afterOpen]();
			}
			*/
		}
		else {
			this.unbind('click');
			this.click(function() {
				//var ysModalDialogChild = $('#YSModalDialog'+dialogId).find(".iziModal-content:first").children(".ysdialog"),
				var href = $(this).attr('href');

				if (optionObj.iframe) {
					$('#YSDialogIframe'+dialogId).iziModal(ysModalDialogIframeOpt);
					$('#loading-div'+dialogId).height($(document).height());
					//$('#loading-div'+dialogId).show();

					if (optionObj.postDataFormId) {
						$('#' + optionObj.postDataFormId).attr('target', 'ysIframe'+dialogId);
						$('#' + optionObj.postDataFormId).attr('action', href);
						$('#' + optionObj.postDataFormId).submit();
					}
					else {
						$('#ysIframe'+dialogId).attr('src', href);
					}

					$('#ysIframe'+dialogId).one('load', function() {
						let YSModalDialogIframe = $('#YSDialogIframe'+dialogId),
							ysIframe = $("#ysIframe"+dialogId);
						
						//$('#loading-div'+dialogId).hide();

						YSModalDialogIframe.iziModal('open');
						ysIframe.contents().find("body").css("margin", "0px");
						ysIframe.contents().find(".btn:last").addClass("btn-no-border");
						resizeYSModalDialogIframe($(this), dialogId);

						//for the compatibility with jquery 1.12.1
						if ($.fn.jquery > "1.10") {
							setTimeout(function(){
//								YSModalDialogIframe.dialog('widget').position({my:"center", at:"center", of: window});
								YSModalDialogIframe.height(ysIframe.height());
							}, 100);
						}
					});
				}
				else {
					
					if (href && href.charAt(0) == '#') {
						var ysModalDialogChild = $('#YSModalDialog'+dialogId).find(".iziModal-content:first").children(".ysdialog");
						
						console.log( '#YSModalDialog'+ dialogId + ".length = " + ysModalDialogChild.length);
						
						if (ysModalDialogChild.length > 0) {
							
							// move current contents of ysdialog to body
							//ysModalDialogChild.appendTo($('body')).hide();
							//$('#YSModalDialog'+dialogId).remove();
							$('#YSModalDialog'+dialogId).iziModal("open");
							
							console.log( '#YSModalDialog'+ dialogId + '.iziModal("open")');
							return false;
						}
						
						$(href).css('display', 'block');
						$(href).appendTo($('#YSModalDialog'+dialogId));
						//$('#YSModalDialog'+dialogId).append();
						$('#YSModalDialog'+dialogId).iziModal(ysModalDialogOpt);
						$('#YSModalDialog'+dialogId).iziModal("open");
						
						console.log( '#YSModalDialog'+ dialogId + '.open');
						
						//for the compatibility with jquery 1.12.1
						if ($.fn.jquery > "1.10") {
//							$('#YSModalDialog'+dialogId).dialog('widget').position({my:"center", at:"center", of: window});
						}
						
						$("#YSModalDialog"+dialogId).find(".btn:last").addClass("btn-no-border");
						//$("#YSModalDialog"+dialogId).css('height', 'auto');
						
						if($("#YSModalDialog"+dialogId).find('.ysdialog-contents').length){
							$("#YSModalDialog"+dialogId).find('.ysdialog-contents').show();
							var dialogW = parseInt($("#YSModalDialog"+dialogId).find('.ysdialog-contents').width() || 400) + 80;
							$("#YSModalDialog"+dialogId).css("min-width",dialogW);
							$("#YSModalDialog"+dialogId).css("width",dialogW);
						}
					}
					else {
						$('#loading-div'+dialogId).height($(document).height());
						$('#loading-div'+dialogId).show();
						
						$('#YSModalDialog'+dialogId).load(href, optionObj, function() {
							
							$(this).iziModal(ysModalDialogOpt);
							$(this).iziModal("open");
							
							$("#YSModalDialog"+dialogId).find(".btn:last").addClass("btn-no-border");
							if (optionObj.validationFormId) {
								$("#" + optionObj.validationFormId).validationEngine();
							}
							//$("#YSModalDialog"+dialogId).css('height', 'auto');
							
							if($("#YSModalDialog"+dialogId).find('.ysdialog-contents').length){
								$("#YSModalDialog"+dialogId).find('.ysdialog-contents').show();
								var dialogW = parseInt($("#YSModalDialog"+dialogId).find('.ysdialog-contents').width() || 400) + 80;
								$("#YSModalDialog"+dialogId).css("min-width",dialogW);
								$("#YSModalDialog"+dialogId).css("width",dialogW);
							}
							
							$('#loading-div'+dialogId).hide();
						}).hide();
					}
					
					
					
					
				}
				return false;
			});
		}
		
		function resizeYSModalDialogIframe(obj, dialogId) {
			obj.width(0);
			obj.height(0);
			
			var ow = obj.contents().width(),
				oh = obj.contents().height();
			
			obj.width(ow);
			obj.height(oh);
			
			$('#YSDialogIframe'+dialogId).css("width", ow + "px");
			$('#YSDialogIframe'+dialogId).css("height", oh + "px");
//			$('#YSDialogIframe'+dialogId, top.document).iziModal('option', 'position', 'center');
		}
		
	};
	
})(jQuery);


